<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>죠기어때</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <link rel="stylesheet" href="header.css">
    <style>
      .review-container{
        display: flex;
        flex-direction: row;
        margin: 50px 50px 20px 50px;
      }

      .image{
        width: 50%;
        padding: 30px;
        margin-right: 50px;
      }

      #imageSec {
        width: 100%;
        height: 90%;
        border: 1px solid lightgray;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      .content{
        width: 50%;
        padding: 30px;
      }

      #inputHotelName, #comment {
        width: 100%;
      }

      .upload {
        margin-top: 20px;
        float: right;
      }

      #uploadBtn {
        width: 130px;
      }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="module">
      // Firebase SDK 라이브러리 가져오기
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";

      import {
        getAuth,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      import { getFirestore, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import { getStorage, ref, uploadBytesResumable, getDownloadURL} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

      import {
        collection,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";


      // Firebase 구성 정보 설정
      const firebaseConfig = {
      apiKey: "AIzaSyDHH6Ed2trAg5FIVv1a3Bo4wEc3lyPszKI",
      authDomain: "carrot-2d67f.firebaseapp.com",
      projectId: "carrot-2d67f",
      storageBucket: "carrot-2d67f.appspot.com",
      messagingSenderId: "425953918397",
      appId: "1:425953918397:web:28ac13bf109bff800c66d4"
      };

      // Firebase 인스턴스 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);
      const auth = getAuth();

      $("#uploadBtn").click(async function (){
        // storage 파일 저장
        let file = document.querySelector('#inputFile').files[0];
        let storageRef = ref(storage, 'reviewImage/' + file.name);
        const uploadTask = uploadBytesResumable(storageRef, file);
          
        uploadTask.on('state_changed',
        (snapshot) => {
          console.log('Upload is');
          
        }, 
        (error) => {
          // A full list of error codes is available at
          // https://firebase.google.com/docs/storage/web/handle-errors
          console.log("업로드 오류 발생");
      }, 
      () => {
        // 업로드 성공 시 실행 
        getDownloadURL(uploadTask.snapshot.ref).then((url) => {
          console.log('업로드된 경로', url);

          let uploadHotelName = $('#hotelName').val();
          let uploadRegion = $('#region').val();
          let uploadRate = $('#rate').val();
          let uploadContent = $('#comment').val();
        
          let doc = {
              '이미지' : url,
              '숙소명' : uploadHotelName,
              '지역' : uploadRegion,
              '평점' : uploadRate,
              '후기' : uploadContent
          };
      
          addDoc(collection(db, "review"), doc).then(() => {
              alert("리뷰 업로드 완료!");
              //console.log()
              //window.location.href = "index.html";
          }).catch((err) =>{
              console.log(err);
              alert("상품 업로드 실패");
          });
        });
      }
      );
    })
    </script>
    <script>
      
      function loadFile(input) {
        let container = document.getElementById('imageSec');
    
        // 기존 이미지를 모두 삭제
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        let file = input.files[0]; // 선택파일 가져오기

        let newImage = document.createElement("img"); //새 이미지 태그 생성

        //이미지 source 가져오기
        newImage.src = URL.createObjectURL(file);
        newImage.style.width = "100%"; 
        newImage.style.height = "100%";
        newImage.style.objectFit = "cover"; // div에 넘치지 않고 들어가게

        //이미지를 image-show div에 추가
        container.appendChild(newImage);
      }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">죠기어때</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
            <form class="d-flex" role="search">
              <input class="form-control me-2" type="search" id="search" placeholder="숙소명을 입력해주세요!" aria-label="Search">
              <button class="btn btn-outline-success" id="searchBtn" type="submit">Search</button>
            </form>
            <div class="sign">
                <button type="button" id="sign-in"class="btn btn-light">마이페이지</button>
                <button type="button" id="sign-up" class="btn">업로드</button>
            </div>
        </div>
      </nav>

      <div class="review-container">
        <div class="image">
          <!-- 이미지 미리보기 -->
          <div id="imageSec">

          </div>
          <!-- 이미지 삽입 -->
          <div class="input-group">
            <form class="inputImg" method="post" enctype="multipart/form-data">
              
              <!-- 이미지 형식 상관없이 모두 받아오기 -->
              <input type="file" id="inputFile" accept="image/*" onchange="loadFile(this)">
            </form>
            <!-- <input type="text" class="form-control" placeholder="이미지 링크 직접 입력" aria-label="Recipient's username with two button addons">
            <button class="btn btn-outline-secondary" type="button">내 파일</button>
            <button class="btn btn-outline-secondary" type="button">적용</button> -->
          </div>
        </div>
        <div class="content">
          <form id="contentBox">
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon1">숙소명</span>
              <input type="text" class="form-control" id="hotelName">
            </div>
            <div class="input-group mb-3">
              <label class="input-group-text" for="inputGroupSelect01">지역</label>
              <select class="form-select" id="region">
                <option selected>지역 선택</option>
                <option value="서울">서울</option>
                <option value="경기도">경기도</option>
                <option value="강원도">강원도</option>
                <option value="충청북도">충청북도</option>
                <option value="충청남도">충청남도</option>
                <option value="대전">대전</option>
                <option value="전라북도">전라남도</option>
                <option value="전라남도">전라북도</option>
                <option value="광주">광주</option>
                <option value="경상북도">경상북도</option>
                <option value="대구">대구</option>
                <option value="경상남도">경상남도</option>
                <option value="울산">울산</option>
                <option value="부산">부산</option>
              </select>
            </div>
            <div class="input-group mb-3">
              <label class="input-group-text" for="inputGroupSelect01">평점</label>
              <select class="form-select" id="rate">
                <option selected>평점 선택</option>
                <option value="⭐">⭐</option>
                <option value="⭐⭐">⭐⭐</option>
                <option value="⭐⭐⭐">⭐⭐⭐</option>
                <option value="⭐⭐⭐⭐">⭐⭐⭐⭐</option>
                <option value="⭐⭐⭐⭐⭐">⭐⭐⭐⭐⭐</option>
              </select>
            </div>
            <div class="form-floating">
              <textarea class="form-control" placeholder="Leave a comment here" id="comment" style="height: 300px"></textarea>
              <label for="comment">숙소평을 남겨주세요!</label>
            </div>
            <div class="upload">
              <button type="button" id="uploadBtn" class="btn" style="background-color: #6A24FE; color: white;">업로드</button>
            </div>
            
          </form>
          
        </div>
      </div>


</body>
</html>